{% extends "dashboard/base.html" %}
{% block title %}Patient Dashboard{% endblock %}

{% block content %}
<div class="box token-card">
    <h2 class="title is-5">Your Current Token</h2>

    <div id="status-area">
        <!-- No token message -->
        <p id="no-token" style="display:none;">
            No active token found.
            <br>
            <a href="/dashboard/patient/" class="button is-link is-small mt-2">
                Book Token
            </a>
        </p>

        <!-- Token info -->
        <div id="token-info" style="display:none;">
            <p><strong>Token Number:</strong> <span id="token-number"></span></p>
            <p><strong>Doctor:</strong> <span id="doctor-name"></span></p>
            <p><strong>Hospital:</strong> <span id="hospital-name"></span></p>
            <p><strong>Status:</strong> <span id="token-status"></span></p>
            <p><strong>Estimated Wait:</strong> <span id="token-eta"></span> minutes</p>

            <button id="refresh" class="button is-small is-info mt-2">
                Refresh
            </button>
        </div>
    </div>
</div>

<script>
    async function fetchMyToken() {
        try {
            const resp = await fetch("/api/tokens/patient/dashboard/", {
                credentials: "same-origin"
            });

            if (!resp.ok) {
                throw new Error("Failed to fetch dashboard data");
            }

            const data = await resp.json();

            const noTokenEl = document.getElementById("no-token");
            const tokenInfoEl = document.getElementById("token-info");

            if (!data.has_active_token) {
                noTokenEl.style.display = "block";
                tokenInfoEl.style.display = "none";
                return;
            }

            // Show token info
            noTokenEl.style.display = "none";
            tokenInfoEl.style.display = "block";

            document.getElementById("token-number").innerText = data.token_number;
            document.getElementById("doctor-name").innerText = data.doctor_name;
            document.getElementById("hospital-name").innerText = data.hospital_name;
            document.getElementById("token-status").innerText = data.status;
            document.getElementById("token-eta").innerText = data.estimated_wait_minutes;

        } catch (err) {
            console.error(err);
            document.getElementById("no-token").innerText =
                "Error loading token details.";
            document.getElementById("no-token").style.display = "block";
            document.getElementById("token-info").style.display = "none";
        }
    }

    // Refresh button
    document.getElementById("refresh").addEventListener("click", fetchMyToken);

    // Initial load
    fetchMyToken();
</script>
{% endblock %}
{% extends "dashboard/base.html" %}
{% block title %}Patient Dashboard{% endblock %}

{% block content %}
<div class="box token-card">
    <h2 class="title is-5">Your Current Token</h2>

    <div id="status-area">

        <!-- No token message -->
        <p id="no-token" style="display:none;">
            No active token found.
            <br><br>

            <!-- âœ… BOOK TOKEN BUTTON -->
            <button id="book-token-btn" class="button is-link is-medium">
                âž• Book Token
            </button>
        </p>

        <!-- Token info -->
        <div id="token-info" style="display:none;">
            <p><strong>Token Number:</strong> <span id="token-number"></span></p>
            <p><strong>Doctor:</strong> <span id="doctor-name"></span></p>
            <p><strong>Hospital:</strong> <span id="hospital-name"></span></p>
            <p><strong>Status:</strong> <span id="token-status"></span></p>
            <p><strong>Estimated Wait:</strong> <span id="token-eta"></span> minutes</p>

            <button id="refresh" class="button is-small is-info mt-2">
                Refresh
            </button>
        </div>
    </div>
</div>

<script>
    async function fetchMyToken() {
        try {
            const resp = await fetch("/api/tokens/patient/dashboard/", {
                credentials: "same-origin"
            });

            if (!resp.ok) {
                throw new Error("Failed to fetch dashboard data");
            }

            const data = await resp.json();

            const noTokenEl = document.getElementById("no-token");
            const tokenInfoEl = document.getElementById("token-info");

            if (!data.has_active_token) {
                noTokenEl.style.display = "block";
                tokenInfoEl.style.display = "none";
                return;
            }

            noTokenEl.style.display = "none";
            tokenInfoEl.style.display = "block";

            document.getElementById("token-number").innerText = data.token_number;
            document.getElementById("doctor-name").innerText = data.doctor_name;
            document.getElementById("hospital-name").innerText = data.hospital_name;
            document.getElementById("token-status").innerText = data.status;
            document.getElementById("token-eta").innerText = data.estimated_wait_minutes;

        } catch (err) {
            console.error(err);
            document.getElementById("no-token").innerText =
                "Error loading token details.";
            document.getElementById("no-token").style.display = "block";
            document.getElementById("token-info").style.display = "none";
        }
    }

    // Refresh button
    document.getElementById("refresh")?.addEventListener("click", fetchMyToken);

    // âœ… Book token button
    document.getElementById("book-token-btn")?.addEventListener("click", async () => {
        try {
            const resp = await fetch("/api/token_queue/book/", {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    doctor: 1   // ðŸ”´ TEMP: hardcoded doctor ID
                })
            });

            if (!resp.ok) {
                const err = await resp.json();
                alert(err.detail || "Booking failed");
                return;
            }

            alert("âœ… Token booked successfully");
            fetchMyToken(); // reload dashboard

        } catch (e) {
            alert("Network error");
        }
    });

    // Initial load
    fetchMyToken();
</script>
{% endblock %}